<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CRUD de Tareas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  </head>
  <body>
    <div class="container py-4">
      <h1 class="mb-4">Gestor de Tareas</h1>

      <!-- Formulario para crear tarea -->
      <form id="form-tarea" class="mb-4">
        <div class="mb-3">
          <label for="persona" class="form-label">Persona</label>
          <input type="text" class="form-control" id="persona" required />
        </div>
        <div class="mb-3">
          <label for="descripcion" class="form-label">Descripción</label>
          <input type="text" class="form-control" id="descripcion" required />
        </div>
        <button type="submit" class="btn btn-primary">Agregar Tarea</button>
      </form>

      <!-- Lista de tareas -->
      <h3>Tareas</h3>
      <ul class="list-group" id="lista-tareas"></ul>
    </div>

    <script>
      const apiUrl = "http://localhost:8000/tareas/";

      // READ - Get tareas
      async function listarTareas() {
        const res = await fetch(apiUrl);
        const tareas = await res.json();
        const lista = document.getElementById("lista-tareas");
        lista.innerHTML = "";

        tareas.forEach((tarea) => {
          const li = document.createElement("li");
          li.className = "list-group-item d-flex justify-content-between align-items-center";

          // Texto con persona y descripción
          li.innerHTML = `
            <div>
                <strong>${tarea.persona}</strong>: ${tarea.descripcion} 
                ${tarea.completada ? '<span class="badge bg-success">Completada</span>' : ""}
            </div>
        `;

          // Botones de acción
          const btnGroup = document.createElement("div");

          // Botón para cambiar completada
          const btnToggle = document.createElement("button");
          btnToggle.className = tarea.completada ? "btn btn-warning btn-sm me-2" : "btn btn-success btn-sm me-2";
          btnToggle.textContent = tarea.completada ? "Marcar Pendiente" : "Marcar Completada";
          btnToggle.onclick = () => toggleCompletada(tarea.id, !tarea.completada);

          // Botón borrar
          const btnDelete = document.createElement("button");
          btnDelete.className = "btn btn-danger btn-sm";
          btnDelete.textContent = "Borrar";
          btnDelete.onclick = () => borrarTarea(tarea.id);

          btnGroup.appendChild(btnToggle);
          btnGroup.appendChild(btnDelete);

          li.appendChild(btnGroup);
          lista.appendChild(li);
        });
      }

      // CREATE - POST
      async function agregarTarea(event) {
        event.preventDefault();
        const persona = document.getElementById("persona").value.trim();
        const descripcion = document.getElementById("descripcion").value.trim();

        if (!persona || !descripcion) {
          alert("Rellena todos los campos");
          return;
        }

        await fetch(apiUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ persona, descripcion }),
        });

        document.getElementById("form-tarea").reset();
        listarTareas();
      }

      // UPDATE - PUT
      async function toggleCompletada(id, completada) {
        // Obtener la tarea original para actualizar solo completada
        const res = await fetch(apiUrl + id);
        const tarea = await res.json();

        tarea.completada = completada;

        await fetch(apiUrl + id, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(tarea),
        });

        listarTareas();
      }

      // DELETE - DELETE
      async function borrarTarea(id) {
        if (confirm("¿Seguro que quieres borrar esta tarea?")) {
          await fetch(apiUrl + id, { method: "DELETE" });
          listarTareas();
        }
      }

      // Evento para crear tarea
      document.getElementById("form-tarea").addEventListener("submit", agregarTarea);

      // Cargar tareas al iniciar
      listarTareas();
    </script>
  </body>
</html>
